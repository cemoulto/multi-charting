   <DOCTYPE !html>
<html>
    <head>

        <script type='text/javascript' src='../node_modules/fusioncharts/fusioncharts.js'></script>
        <script type='text/javascript' src='../node_modules/fusioncharts/fusioncharts.timeseries.js'></script>
        <script type='text/javascript' src='../out/fusioncharts.multicharting.js'></script>
        <script type='text/javascript' src='../node_modules/fusioncharts/themes/fusioncharts.theme.ocean.js'></script>

    </head>

    <body onload=''>

        <center style='margin: 10px'>
            <div id="matrix">
                <div id='loadingtxt'>Loading File</div>  <progress id="progress" value="0"></progress>
            </div>
        </center>

        <style type="text/css">
            
/*            #matrix {
                width: 750px;
                position: relative;
                display: inline-block;
            }
*/
            #matrix div {
                border: 1px solid #CCCCCC;
                vertical-align: middle;
            }
        
        </style>

        <script type='text/javascript'>
            var MultiChartObj = new MultiCharting(),
                months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                confTS = {
                    "chart": {
                        "axes": [{
                            "x": {},
                            "y": {}
                        }],
                        "datasets": [{
                            "category": {
                                "dateformat": "%b %e %Y"
                            },
                            "dataset": [{
                                "uid": "ds-1",
                                "series": [{
                                    "plot": {
                                        "style": {
                                            "fill": "#0f4d8c"
                                        },
                                        "type":"column"
                                    },
                                    "name": "Series 1"
                                }]
                            }]
                        }]
                    }
                },
                confCol = {
                    "chart": {
                        "theme": "ocean",
                        "caption": "Date",
                        "captionAlignment": "left",
                        "showYAxisValues": 0,
                        "showLegend": 0,
                        "showValues": 0
                    }
                },
            	dataStore,
            	dataProcessor1,
            	dataProcessor2,
            	data,
            	sortOperator,
            	filterOperator,
            	newData1,
            	newData2;

            dataStore = MultiChartObj.createDataStore();

            function parseDate(d) {
                // d = d || '';
                return new Date(2001,
                    d.substring(0, 2) - 1,
                    d.substring(2, 4),
                    d.substring(4, 6),
                    d.substring(6, 8));
            }

            // Progress bar element reference
            progressBar = document.getElementById("progress");
            loadingTxt = document.getElementById("loadingtxt");

            // Ajax events
            MultiChartObj.addEventListener('onloadstart', function(e, a) {
                a = a.Event;
                progressBar.value = 0;
                loadingTxt.innerHTML = 'Loading file...'
            });
            MultiChartObj.addEventListener('onprogress', function(e, a) {
                a = a.Event;
                progressBar.max = a.total;
                progressBar.value = a.loaded;
            });
            MultiChartObj.addEventListener('onloadend', function(e, a) {
                a = a.Event;
                progressBar.value = a.loaded;
            });

            // Multi-charting events
            MultiChartObj.addEventListener('onParsingStart', function(e, a) {
                a = a.Event;
                progressBar.max = a.total;
                loadingTxt.innerHTML = 'Parsing data...'
            });
            MultiChartObj.addEventListener('onParsingProgress', function(e, a) {
                a = a.Event;
                progressBar.max = a.total;
                progressBar.value = a.loaded;
            });
            MultiChartObj.addEventListener('onParsingEnd', function(e, a) {
                a = a.Event;
                progressBar.value = a.loaded;
            });

            dataStore.setDataUrl({
                // dataSource: 'airline-small.csv',
                dataSource: 'airline.csv',
                dataType: 'csv',
                outputFormat: 2
            },
            function (data) {

                    var filterByDate = function (data) {
                            var flights = {
                                },
                                // dataArr = [['Date', 'Flights']],
                                dataArr = [],
                                i;
                            data.forEach(function (row) {
                                if (!flights[row.fulldate]) {
                                    flights[row.fulldate] = {
                                        i: months[row.D.getMonth()] + ' ' + row.D.getDate() + ' ' + row.D.getFullYear(),
                                        v: 0
                                    };
                                }
                                flights[row.fulldate].v += 1;
                            });
                            for (var i in flights) {
                                // dataArr.push([flights[i].i, flights[i].v]);
                                dataArr.push({"Date": flights[i].i, "Flights": flights[i].v});
                            }
                            return dataArr;
                        },
                        filterByTime = function (data) {
                            var flights = {
                                },
                                // dataArr = [['Time', 'Flights']],
                                dataArr = [],
                                i;
                            // debugger;
                            data.forEach(function (row) {
                                if (!flights[row.time]) {
                                    flights[row.time] = 0;
                                }
                                flights[row.time] += 1;
                            });
                            for (var i in flights) {
                                dataArr.push({"Time": i, "Flights": flights[i]});
                            }
                            return dataArr;
                        },
                        filterByArrival = function (data) {
                            var flights = {
                                },
                                dataArr = [],
                                i,
                                c,
                                val;

                            for (i = -60, c = 0; i <= 150; i += 10, c++) {
                                flights[i/10] = {v: i, s: 0};
                            }

                            data.forEach(function (row) {
                                val = Number(row.delay);

                                let index = Math.ceil(val / 10),
                                    infoObj = flights[index];

                                if (flights[index]) {
                                    flights[index].s += 1;
                                }
                            });
                            for (i in flights) {
                                dataArr.push([flights[i].v, flights[i].s]);
                                dataArr.push({"Arrival": flights[i].v, "Flights": flights[i].s});
                            }
                            dataArr.sort(function (a, b) { 
                                return a.Arrival < b.Arrival ? -1 : 1;
                                // return a[0] < b[0] ? -1 : 1;
                            });
                            // dataArr.unshift(['Arrival', 'Flights']);
                            return dataArr;
                        },
                        filterByDistance = function (data) {
                            var flights = {},
                                dataArr = [],
                                // dataArr = [['Distance', 'Flights']],
                                i,
                                c;
                            for (i = 50, c = 0; i <= 2000; i += 50, c++) {
                                flights[c] = {
                                    // v: i % 200 == 0 ? i : '',
                                    v: i,
                                    s: 0
                                };
                            }
                            data.forEach(function (row) {
                                let index = Math.floor(row.distance / 50),
                                    infoObj = flights[index];
                                if (flights[index]) {
                                    flights[index].s += 1;
                                }
                            });

                            for (var i in flights) {
                                // dataArr.push([flights[i].v, flights[i].s]);
                                dataArr.push({"Distance": flights[i].v, "Flights": flights[i].s});
                            }
                            return dataArr;
                        },
                        mapFilter = function (row, i) {
                            var d = parseDate(row.date);
                            row.D = d;
                            row.fulldate = d.getMonth() + '-' + d.getDate() + '-' + d.getFullYear();
                            row.time = d.getHours();
                            return row;
                        };

                    // Parse the date and add information in the data
                    map = MultiChartObj.createDataProcessor();
                    map.map(mapFilter);
                    newData = dataStore.getChildModel(map);

                    // filter number of flights by date
                    dateDataProcessor = MultiChartObj.createDataProcessor();
                    dateDataProcessor.addRule({rule: filterByDate});
                    flightByDate = dataStore.getChildModel(dateDataProcessor);

                    // filter number of flights by time of day
                    timeDataProcessor = MultiChartObj.createDataProcessor();
                    timeDataProcessor.addRule({rule: filterByTime});
                    flightByTime = dataStore.getChildModel(timeDataProcessor);
                    
                    
                    // filter number of flights by arrival delay (min)
                    arrivalDataProcessor = MultiChartObj.createDataProcessor();
                    arrivalDataProcessor.addRule({rule: filterByArrival});
                    flightByArrival = dataStore.getChildModel(arrivalDataProcessor);

                    // filter number of flights by distance
                    distanceDataProcessor = MultiChartObj.createDataProcessor();
                    distanceDataProcessor.addRule({rule: filterByDistance});
                    flightByDistance = dataStore.getChildModel(distanceDataProcessor);

                    window.nd = newData;
                    window.dt = flightByDate;
                    window.t = flightByTime;
                    window.a = flightByArrival;
                    window.di = flightByDistance;

                    TIMESERIES = 0;

                    configuration = [
                        [{
                            "height": 150,
                            "width": 250,
                            "html": "Chart 1",
                            "chart": MultiChartObj.chart({
                            // "chart": {
                                "type": "MScolumn2d",
                                "width": "100%",
                                "height": "100%",
                                "dataSource": flightByTime,
                                "dimension": ["Time"],
                                "measure": ["Flights"],
                                "seriesType": "MS",
                                "config": {
                                    "chart": {
                                        "caption": "Time of Day",
                                        "captionAlignment": "left",
                                        "showLegend": 0,
                                        "showValues": 0,
                                        "showYAxisValues": 0,
                                        "theme": "ocean"
                                    }
                                }
                            })
                        }, {
                            "height": 120,
                            "width": 250,
                            "id": "1",
                            "html": "Chart 2",
                            "chart": MultiChartObj.chart({
                                "type": "MScolumn2d",
                                "width": "100%",
                                "height": "100%",
                                "dataSource": flightByArrival,
                                "dimension": ["Arrival"],
                                "measure": ["Flights"],
                                "seriesType": "MS",
                                "config": {
                                    "chart": {
                                        "caption": "Arrival Delay",
                                        "captionAlignment": "left",
                                        "showLegend": 0,
                                        "showValues": 0,
                                        "showYAxisValues": 0,
                                        "theme": "ocean"
                                    }
                                }                    
                            })
                        }, {
                            "height": 120,
                            "width": 400,
                            "id": "2",
                            "html": "html3",
                            "chart": MultiChartObj.chart({
                                "type": "MScolumn2d",
                                "dataSource": flightByDistance,
                                "dimension": ["Distance"],
                                "measure": ["Flights"],
                                "seriesType": "MS",
                                "config": {
                                    "chart": {
                                        "caption": "Distance",
                                        "captionAlignment": "left",
                                        "showLegend": 0,
                                        "showValues": 0,
                                        "showYAxisValues": 0,
                                        "theme": "ocean"
                                    }
                                }                    
                            })
                        }], [{
                            "height": 200,
                            "width": 900,
                            "colspan": 3,
                            "id": "4",
                            "html": "html4",
                            "chart": MultiChartObj.chart({
                                "type": !TIMESERIES ? "MScolumn2d" : "TimeSeries",
                                "dataSource": flightByDate,
                                "dimension": ["Date"],
                                "measure": ["Flights"],
                                "seriesType": !TIMESERIES ? "MS" : "TS",
                                "config": !TIMESERIES ? confCol : confTS,
                                "callback": function (data) {
                                    return data;
                                }
                            })
                        }]
                    ]

                    matrix = MultiChartObj.createMatrix('matrix', configuration);
                    matrix.draw();


            });

        </script>

    </body>


</html>